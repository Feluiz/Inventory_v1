This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
.gitignore
App.tsx
components/Dashboard.tsx
components/Inventory.tsx
components/Layout.tsx
components/Orders.tsx
components/Reports.tsx
constants.tsx
index.html
index.tsx
metadata.json
package.json
README.md
services/geminiService.ts
tsconfig.json
types.ts
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

<file path="index.html">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Don Rafa Group ERP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body {
        font-family: 'Inter', sans-serif;
        background-color: #f8fafc;
      }
      @media print {
        .no-print { display: none !important; }
        .print-only { display: block !important; }
        body { background: white; }
      }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.40.0",
    "react/": "https://esm.sh/react@^19.2.4/",
    "react": "https://esm.sh/react@^19.2.4",
    "react-dom/": "https://esm.sh/react-dom@^19.2.4/",
    "recharts": "https://esm.sh/recharts@^3.7.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body>
    <div id="root"></div>
<script type="module" src="/index.tsx"></script>
</body>
</html>
</file>

<file path="index.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path="metadata.json">
{
  "name": "Copy of Don Rafa Group ERP",
  "description": "A comprehensive inventory and order management system for the Don Rafa Group brands: Finca Don Rafa, Yuteco, and Ecotact. Features role-based access, multi-brand support, inventory tracking, and smart reporting.",
  "requestFramePermissions": []
}
</file>

<file path="package.json">
{
  "name": "copy-of-don-rafa-group-erp",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "@google/genai": "^1.40.0",
    "react": "^19.2.4",
    "react-dom": "^19.2.4",
    "recharts": "^3.7.0"
  },
  "devDependencies": {
    "@types/node": "^22.14.0",
    "@vitejs/plugin-react": "^5.0.0",
    "typescript": "~5.8.2",
    "vite": "^6.2.0"
  }
}
</file>

<file path="services/geminiService.ts">
import { GoogleGenAI, Type } from "@google/genai";

const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

export async function getReportInsights(reportData: any) {
  try {
    const response = await ai.models.generateContent({
      model: 'gemini-3-flash-preview',
      contents: `Analyze the following sales and inventory report for a coffee production group and provide 3 key business recommendations in a concise JSON format:
      ${JSON.stringify(reportData)}`,
      config: {
        responseMimeType: "application/json",
        responseSchema: {
          type: Type.OBJECT,
          properties: {
            insights: {
              type: Type.ARRAY,
              items: { type: Type.STRING }
            }
          },
          required: ["insights"]
        }
      }
    });

    return JSON.parse(response.text).insights;
  } catch (error) {
    console.error("Gemini Insight Error:", error);
    return ["Optimize stock for high-demand items.", "Review shipping costs for Ecotact products.", "Focus on Finca Don Rafa seasonal peaks."];
  }
}
</file>

<file path="tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2022",
    "experimentalDecorators": true,
    "useDefineForClassFields": false,
    "module": "ESNext",
    "lib": [
      "ES2022",
      "DOM",
      "DOM.Iterable"
    ],
    "skipLibCheck": true,
    "types": [
      "node"
    ],
    "moduleResolution": "bundler",
    "isolatedModules": true,
    "moduleDetection": "force",
    "allowJs": true,
    "jsx": "react-jsx",
    "paths": {
      "@/*": [
        "./*"
      ]
    },
    "allowImportingTsExtensions": true,
    "noEmit": true
  }
}
</file>

<file path="vite.config.ts">
import path from 'path';
import { defineConfig, loadEnv } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig(({ mode }) => {
    const env = loadEnv(mode, '.', '');
    return {
      server: {
        port: 3000,
        host: '0.0.0.0',
      },
      plugins: [react()],
      define: {
        'process.env.API_KEY': JSON.stringify(env.GEMINI_API_KEY),
        'process.env.GEMINI_API_KEY': JSON.stringify(env.GEMINI_API_KEY)
      },
      resolve: {
        alias: {
          '@': path.resolve(__dirname, '.'),
        }
      }
    };
});
</file>

<file path="App.tsx">
import React, { useState, useEffect } from 'react';
import { User, Role, Brand, Product, Order, OrderStatus, LogEntry, Location } from './types';
import { INITIAL_USERS, INITIAL_PRODUCTS, INITIAL_ORDERS, BRANDS, LOCATIONS } from './constants';
import Layout from './components/Layout';
import Dashboard from './components/Dashboard';
import Orders from './components/Orders';
import Inventory from './components/Inventory';
import Reports from './components/Reports';

const App: React.FC = () => {
  const [user, setUser] = useState<User | null>(null);
  const [activeBrand, setActiveBrand] = useState<Brand>(BRANDS[0]);
  const [activeLocation, setActiveLocation] = useState<Location>(LOCATIONS[0]);
  const [currentView, setCurrentView] = useState('dashboard');
  const [products, setProducts] = useState<Product[]>(INITIAL_PRODUCTS);
  const [orders, setOrders] = useState<Order[]>(INITIAL_ORDERS);
  const [allUsers, setAllUsers] = useState<User[]>(INITIAL_USERS);

  // Auto-login for demo purposes
  useEffect(() => {
    if (!user) setUser(INITIAL_USERS[0]);
  }, [user]);

  const handleLogout = () => {
    alert("Logged out successfully");
    setUser(null);
  };

  const updateOrderStatus = (orderId: string, status: OrderStatus) => {
    const order = orders.find(o => o.id === orderId);
    if (!order) return;

    // Fulfill from the order's designated location
    if (status === OrderStatus.CONFIRMED && order.status !== OrderStatus.CONFIRMED) {
      setProducts(prevProducts => {
        return prevProducts.map(p => {
          const item = order.items.find(oi => oi.productId === p.id);
          if (item) {
            const newLog: LogEntry = {
              id: `log-${Date.now()}-${Math.random()}`,
              type: 'SALE',
              eventNumber: order.id,
              change: `Sold ${item.quantity} ${p.unit} from ${order.locationId}`,
              date: new Date().toISOString(),
              quantity: `${item.quantity} ${p.unit}`,
              userId: user?.id || 'sys',
              userName: user?.name || 'System',
              authorizerName: user?.name || 'System',
              locationId: order.locationId
            };
            
            const currentStock = p.locationStocks[order.locationId] || 0;
            return {
              ...p,
              locationStocks: {
                ...p.locationStocks,
                [order.locationId]: currentStock - item.quantity
              },
              history: [...p.history, newLog]
            };
          }
          return p;
        });
      });
    }

    setOrders(prev => prev.map(o => o.id === orderId ? { ...o, status, updatedAt: new Date().toISOString() } : o));
  };

  const createOrder = (orderData: Partial<Order>) => {
    const newOrder: Order = {
      id: `ORD-${Math.floor(Math.random() * 900) + 100}`,
      brand: activeBrand,
      locationId: activeLocation.id, // Linked to current session location
      creatorId: user?.id || '',
      creatorName: user?.name || '',
      clientName: orderData.clientName || '',
      clientEmail: orderData.clientEmail || '',
      status: OrderStatus.PENDING,
      items: orderData.items || [],
      total: orderData.total || 0,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    setOrders(prev => [newOrder, ...prev]);
  };

  const updateStock = (productId: string, newStock: number) => {
    setProducts(prev => prev.map(p => {
      if (p.id === productId) {
        const oldStock = p.locationStocks[activeLocation.id] || 0;
        const added = newStock - oldStock;
        const eventNum = `REST-${Math.floor(1000 + Math.random() * 9000)}`;
        const newLog: LogEntry = {
          id: `log-${Date.now()}`,
          type: 'RESTOCK',
          eventNumber: eventNum,
          change: `Restock of ${added} units at ${activeLocation.name}`,
          date: new Date().toISOString(),
          quantity: `${added} ${p.unit}`,
          userId: user?.id || 'sys',
          userName: user?.name || 'System',
          authorizerName: user?.name || 'System',
          locationId: activeLocation.id
        };
        return { 
          ...p, 
          locationStocks: {
            ...p.locationStocks,
            [activeLocation.id]: newStock
          },
          lastRestockAmount: added > 0 ? added : p.lastRestockAmount,
          history: [...p.history, newLog] 
        };
      }
      return p;
    }));
  };

  const updatePrice = (productId: string, newPrice: number) => {
    setProducts(prev => prev.map(p => {
      if (p.id === productId) {
        const eventNum = `PRC-${Math.random().toString(36).substring(2, 7).toUpperCase()}`;
        const newLog: LogEntry = {
          id: `log-${Date.now()}`,
          type: 'PRICE_CHANGE',
          eventNumber: eventNum,
          change: `$${p.price.toFixed(2)} -> $${newPrice.toFixed(2)}`,
          date: new Date().toISOString(),
          authorizerName: user?.name || 'System',
          userId: user?.id || 'sys',
          userName: user?.name || 'System'
        };
        return { 
          ...p, 
          price: newPrice, 
          history: [...p.history, newLog] 
        };
      }
      return p;
    }));
  };

  const bulkUpdateInventory = (
    updates: { productId: string, addedStock: number, newPrice: number }[], 
    batchNumber: string,
    sourceLocationId?: string,
    purchaseOrder?: string
  ) => {
    setProducts(prev => prev.map(p => {
      const update = updates.find(u => u.productId === p.id);
      if (update) {
        let newHistory = [...p.history];
        let newLocationStocks = { ...p.locationStocks };
        let newPrice = p.price;
        let lastRestock = p.lastRestockAmount;

        if (update.addedStock !== 0) {
          const isTransfer = sourceLocationId && sourceLocationId !== 'restock';
          const sourceLoc = isTransfer ? LOCATIONS.find(l => l.id === sourceLocationId) : null;
          
          const restockLog: LogEntry = {
            id: `log-bulk-rest-${p.id}-${Date.now()}`,
            type: 'RESTOCK',
            eventNumber: isTransfer ? batchNumber : (purchaseOrder || batchNumber),
            change: isTransfer 
              ? `Stock transfer: ${update.addedStock} units from ${sourceLoc?.name} to ${activeLocation.name}`
              : `Bulk restock of ${update.addedStock} units at ${activeLocation.name} (PO: ${purchaseOrder || 'N/A'})`,
            date: new Date().toISOString(),
            quantity: `${update.addedStock} ${p.unit}`,
            userId: user?.id || 'sys',
            userName: user?.name || 'System',
            authorizerName: user?.name || 'System',
            locationId: activeLocation.id
          };
          newHistory.push(restockLog);
          
          // Add to target
          newLocationStocks[activeLocation.id] = (newLocationStocks[activeLocation.id] || 0) + update.addedStock;
          
          // Subtract from source if it's a transfer
          if (isTransfer) {
            newLocationStocks[sourceLocationId] = (newLocationStocks[sourceLocationId] || 0) - update.addedStock;
            
            // Log subtraction at source
            const transferOutLog: LogEntry = {
              id: `log-transfer-out-${p.id}-${Date.now()}`,
              type: 'SALE',
              eventNumber: batchNumber,
              change: `Stock transfer: ${update.addedStock} units moved to ${activeLocation.name}`,
              date: new Date().toISOString(),
              quantity: `${update.addedStock} ${p.unit}`,
              userId: user?.id || 'sys',
              userName: user?.name || 'System',
              authorizerName: user?.name || 'System',
              locationId: sourceLocationId
            };
            newHistory.push(transferOutLog);
          }

          if (update.addedStock > 0) lastRestock = update.addedStock;
        }

        if (update.newPrice !== p.price) {
          const priceLog: LogEntry = {
            id: `log-bulk-prc-${p.id}-${Date.now()}`,
            type: 'PRICE_CHANGE',
            eventNumber: batchNumber,
            change: `$${p.price.toFixed(2)} -> $${update.newPrice.toFixed(2)}`,
            date: new Date().toISOString(),
            quantity: `$${update.newPrice.toFixed(2)}`,
            userId: user?.id || 'sys',
            userName: user?.name || 'System',
            authorizerName: user?.name || 'System'
          };
          newHistory.push(priceLog);
          newPrice = update.newPrice;
        }

        return {
          ...p,
          locationStocks: newLocationStocks,
          price: newPrice,
          lastRestockAmount: lastRestock,
          history: newHistory
        };
      }
      return p;
    }));
  };

  const createCatalogProduct = (productData: Partial<Product>) => {
    const eventNum = `CAT-${Math.floor(100 + Math.random() * 899)}`;
    const creationLog: LogEntry = {
      id: `log-creation-${Date.now()}`,
      type: 'CATALOG_CREATE',
      eventNumber: eventNum,
      change: `Product defined in catalog: ${productData.name}`,
      date: new Date().toISOString(),
      userId: user?.id || 'sys',
      userName: user?.name || 'System',
      authorizerName: user?.name || 'System'
    };

    const newProduct: Product = {
      id: productData.id || `p-${Date.now()}`,
      brand: productData.brand || BRANDS[0],
      name: productData.name || 'New Product',
      price: productData.price || 0,
      locationStocks: {}, // Starts empty for all locations
      lastRestockAmount: 0,
      unit: productData.unit || 'units',
      category: productData.category || 'General',
      status: productData.status || 'ACTIVE',
      observations: productData.observations || '',
      history: [creationLog]
    };

    setProducts(prev => [...prev, newProduct]);
  };

  const updateCatalogProduct = (productData: Product) => {
    const eventNum = `CAT-${Math.floor(100 + Math.random() * 899)}`;
    const updateLog: LogEntry = {
      id: `log-update-${Date.now()}`,
      type: 'CATALOG_UPDATE',
      eventNumber: eventNum,
      change: `Catalog information updated for: ${productData.name}`,
      date: new Date().toISOString(),
      userId: user?.id || 'sys',
      userName: user?.name || 'System',
      authorizerName: user?.name || 'System'
    };

    setProducts(prev => prev.map(p => {
      if (p.id === productData.id) {
        return {
          ...p,
          ...productData,
          history: [...p.history, updateLog]
        };
      }
      return p;
    }));
  };

  if (!user) return (
    <div className="min-h-screen bg-slate-900 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-gray-900">Don Rafa Group</h1>
          <p className="text-gray-500 mt-2">Inventory Management System</p>
        </div>
        <div className="space-y-4">
          <p className="text-sm font-medium text-gray-700 text-center">Demo: Select a profile to enter</p>
          {INITIAL_USERS.map(u => (
            <button
              key={u.id}
              onClick={() => {
                setUser(u);
                setActiveBrand(u.brands[0]);
              }}
              className="w-full p-4 border border-gray-200 rounded-xl hover:bg-emerald-50 hover:border-emerald-200 transition-all text-left flex items-center justify-between group"
            >
              <div>
                <p className="font-bold text-gray-900">{u.name}</p>
                <p className="text-xs text-gray-500 capitalize">{u.role.toLowerCase()}</p>
              </div>
              <i className="fas fa-chevron-right text-gray-300 group-hover:text-emerald-500"></i>
            </button>
          ))}
        </div>
      </div>
    </div>
  );

  return (
    <Layout 
      user={user} 
      onLogout={handleLogout} 
      activeBrand={activeBrand} 
      setActiveBrand={setActiveBrand}
      activeLocation={activeLocation}
      setActiveLocation={setActiveLocation}
      currentView={currentView}
      setCurrentView={setCurrentView}
    >
      {currentView === 'dashboard' && <Dashboard orders={orders} products={products} activeBrand={activeBrand} activeLocation={activeLocation} />}
      {currentView === 'orders' && (
        <Orders 
          orders={orders} 
          products={products} 
          currentUser={user} 
          activeBrand={activeBrand}
          activeLocation={activeLocation}
          onUpdateStatus={updateOrderStatus}
          onCreateOrder={createOrder}
        />
      )}
      {currentView === 'inventory' && (
        <Inventory 
          products={products} 
          currentUser={user} 
          activeBrand={activeBrand} 
          activeLocation={activeLocation}
          onUpdateStock={updateStock}
          onUpdatePrice={updatePrice}
          onBulkUpdate={bulkUpdateInventory}
          onAddProduct={createCatalogProduct}
          onUpdateProduct={updateCatalogProduct}
        />
      )}
      {currentView === 'reports' && <Reports orders={orders} products={products} activeBrand={activeBrand} />}
      
      {currentView === 'employees' && user.role === Role.ADMIN && (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-bold text-gray-800">Employee Directory</h2>
            <button className="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-slate-800 transition-all">Add New Employee</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {allUsers.map(u => (
              <div key={u.id} className="bg-white p-6 rounded-2xl border border-gray-200 shadow-sm relative group overflow-hidden hover:border-emerald-200 transition-all">
                <div className="flex items-center space-x-4">
                  <div className="h-12 w-12 bg-emerald-100 text-emerald-700 rounded-full flex items-center justify-center font-bold text-xl">
                    {u.name.charAt(0)}
                  </div>
                  <div>
                    <h3 className="font-bold text-gray-900">{u.name}</h3>
                    <p className="text-xs text-gray-500">{u.department}</p>
                  </div>
                </div>
                <div className="mt-4 space-y-2">
                  <div className="flex items-center text-xs text-gray-500">
                    <i className="fas fa-envelope w-5 text-slate-300"></i> {u.email}
                  </div>
                  <div className="flex items-center text-xs text-gray-500">
                    <i className="fas fa-shield-halved w-5 text-slate-300"></i> {u.role}
                  </div>
                </div>
                <div className="mt-4 pt-4 border-t border-gray-50 flex flex-wrap gap-1">
                  {u.brands.map(b => (
                    <span key={b} className="px-2 py-0.5 bg-gray-100 text-[10px] font-bold text-gray-600 rounded uppercase">{b}</span>
                  ))}
                </div>
                <button className="absolute top-4 right-4 text-gray-300 hover:text-gray-600 opacity-0 group-hover:opacity-100 transition-opacity">
                  <i className="fas fa-ellipsis-v"></i>
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </Layout>
  );
};

export default App;
</file>

<file path="components/Dashboard.tsx">
import React from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { Brand, Order, Product, OrderStatus, Location } from '../types';

interface DashboardProps {
  orders: Order[];
  products: Product[];
  activeBrand: Brand;
  activeLocation: Location;
}

const Dashboard: React.FC<DashboardProps> = ({ orders, products, activeBrand, activeLocation }) => {
  const brandOrders = orders.filter(o => o.brand === activeBrand && o.locationId === activeLocation.id);
  const brandProducts = products.filter(p => p.brand === activeBrand);
  
  const totalRevenue = brandOrders
    .filter(o => o.status !== OrderStatus.REJECTED && o.status !== OrderStatus.PENDING)
    .reduce((sum, o) => sum + o.total, 0);

  const pendingOrders = brandOrders.filter(o => o.status === OrderStatus.PENDING).length;
  // Low stock check for current location
  const lowStockItems = brandProducts.filter(p => (p.locationStocks[activeLocation.id] || 0) < 100).length;

  const chartData = [
    { name: 'Mon', sales: 4000 },
    { name: 'Tue', sales: 3000 },
    { name: 'Wed', sales: 5000 },
    { name: 'Thu', sales: 2780 },
    { name: 'Fri', sales: 1890 },
    { name: 'Sat', sales: 2390 },
    { name: 'Sun', sales: 3490 },
  ];

  return (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
          <div className="flex items-center space-x-3 text-emerald-600 mb-2">
            <i className="fas fa-money-bill-wave text-xl"></i>
            <h3 className="text-sm font-medium text-gray-500">Site Revenue</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">${totalRevenue.toLocaleString()}</p>
          <p className="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-tighter">{activeLocation.name}</p>
        </div>
        
        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
          <div className="flex items-center space-x-3 text-blue-600 mb-2">
            <i className="fas fa-hourglass-half text-xl"></i>
            <h3 className="text-sm font-medium text-gray-500">Local Pending</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">{pendingOrders}</p>
          <p className="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-tighter">Orders at site</p>
        </div>

        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm border-l-4 border-l-red-500">
          <div className="flex items-center space-x-3 text-red-600 mb-2">
            <i className="fas fa-exclamation-triangle text-xl"></i>
            <h3 className="text-sm font-medium text-gray-500">Local Low Stock</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">{lowStockItems}</p>
          <p className="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-tighter">Items below 100 at site</p>
        </div>

        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
          <div className="flex items-center space-x-3 text-amber-600 mb-2">
            <i className="fas fa-box text-xl"></i>
            <h3 className="text-sm font-medium text-gray-500">Brand Portfolio</h3>
          </div>
          <p className="text-2xl font-bold text-gray-900">{brandProducts.length}</p>
          <p className="text-[10px] text-gray-400 mt-1 uppercase font-bold tracking-tighter">SKUs assigned to {activeBrand}</p>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-80">
          <h3 className="text-lg font-bold text-gray-800 mb-4">Site Sales Performance</h3>
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
              <XAxis dataKey="name" axisLine={false} tickLine={false} />
              <YAxis axisLine={false} tickLine={false} />
              <Tooltip cursor={{fill: '#f8fafc'}} />
              <Bar dataKey="sales" fill="#10b981" radius={[4, 4, 0, 0]} />
            </BarChart>
          </ResponsiveContainer>
        </div>

        <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
          <h3 className="text-lg font-bold text-gray-800 mb-4">Local Stock Preview</h3>
          <div className="space-y-4">
            {brandProducts.slice(0, 5).map(p => {
              const currentStock = p.locationStocks[activeLocation.id] || 0;
              return (
                <div key={p.id} className="flex items-center justify-between py-2 border-b border-gray-50 last:border-0">
                  <div>
                    <p className="font-semibold text-gray-800">{p.name}</p>
                    <p className="text-xs text-gray-500">{p.category}</p>
                  </div>
                  <div className={`px-2 py-1 rounded text-xs font-bold ${currentStock < 100 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                    {currentStock} {p.unit}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </div>
    </div>
  );
};

export default Dashboard;
</file>

<file path="components/Inventory.tsx">
import React, { useState } from 'react';
import { Product, Brand, User, Role, LogEntry, Location } from '../types';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } from 'recharts';
import { BRAND_HEX, BRANDS, LOCATIONS } from '../constants';

interface InventoryProps {
  products: Product[];
  currentUser: User;
  activeBrand: Brand;
  activeLocation: Location;
  onUpdateStock: (productId: string, newStock: number) => void;
  onUpdatePrice: (productId: string, newPrice: number) => void;
  onBulkUpdate?: (updates: { productId: string, addedStock: number, newPrice: number }[], batchNumber: string, sourceId?: string, purchaseOrder?: string) => void;
  onAddProduct?: (product: Partial<Product>) => void;
  onUpdateProduct?: (product: Product) => void;
}

const Inventory: React.FC<InventoryProps> = ({ 
  products, 
  currentUser, 
  activeBrand, 
  activeLocation,
  onUpdateStock, 
  onUpdatePrice, 
  onBulkUpdate, 
  onAddProduct,
  onUpdateProduct
}) => {
  const [editingId, setEditingId] = useState<string | null>(null);
  const [editValue, setEditValue] = useState<number>(0);
  const [editType, setEditType] = useState<'stock' | 'price'>('stock');
  const [historyProduct, setHistoryProduct] = useState<Product | null>(null);
  const [isBulkModalOpen, setIsBulkModalOpen] = useState(false);
  const [isCatalogModalOpen, setIsCatalogModalOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState<Product | null>(null);

  // Bulk Modal States
  const [bulkBatchNumber, setBulkBatchNumber] = useState(`BATCH-${Math.floor(1000 + Math.random() * 9000)}`);
  const [bulkSourceId, setBulkSourceId] = useState<string>('restock'); // 'restock' or locationId
  const [purchaseOrder, setPurchaseOrder] = useState<string>('');
  const [bulkEntries, setBulkEntries] = useState<Record<string, { addedStock: number, newPrice: number }>>({});
  const [bulkSearch, setBulkSearch] = useState('');

  // Catalog Form States
  const [newProductForm, setNewProductForm] = useState<Partial<Product>>({
    id: '',
    name: '',
    brand: activeBrand,
    price: 0,
    unit: 'units',
    category: 'General',
    status: 'ACTIVE',
    observations: ''
  });

  const brandProducts = products.filter(p => p.brand === activeBrand);

  const handleEditStockOrPrice = (product: Product, type: 'stock' | 'price') => {
    setEditingId(product.id);
    setEditType(type);
    setEditValue(type === 'stock' ? (product.locationStocks[activeLocation.id] || 0) : product.price);
  };

  const saveInlineEdit = () => {
    if (editingId) {
      if (editType === 'stock') onUpdateStock(editingId, editValue);
      else onUpdatePrice(editingId, editValue);
    }
    setEditingId(null);
  };

  const handleBulkEntryChange = (productId: string, field: 'addedStock' | 'newPrice', value: number) => {
    setBulkEntries(prev => {
      const current = prev[productId] || { addedStock: 0, newPrice: products.find(p => p.id === productId)?.price || 0 };
      return {
        ...prev,
        [productId]: {
          ...current,
          [field]: value
        }
      };
    });
  };

  const handleBulkSubmit = () => {
    const updates = Object.entries(bulkEntries)
      .map(([productId, entry]) => ({
        productId,
        addedStock: entry.addedStock,
        newPrice: entry.newPrice
      }))
      .filter(u => u.addedStock !== 0 || u.newPrice !== products.find(p => p.id === u.productId)?.price);

    if (updates.length === 0) {
      alert("No changes to process.");
      return;
    }

    if (bulkSourceId === 'restock' && !purchaseOrder) {
      alert("Please enter a Purchase Order # for restocking.");
      return;
    }

    // Basic validation for transfers: check if source has enough stock
    if (bulkSourceId !== 'restock') {
      const sourceLoc = LOCATIONS.find(l => l.id === bulkSourceId);
      for (const update of updates) {
        const prod = products.find(p => p.id === update.productId);
        const sourceStock = prod?.locationStocks[bulkSourceId] || 0;
        if (update.addedStock > sourceStock) {
          alert(`Not enough stock in ${sourceLoc?.name} for product: ${prod?.name}. Current: ${sourceStock}`);
          return;
        }
      }
    }

    if (onBulkUpdate) {
      onBulkUpdate(updates, bulkBatchNumber, bulkSourceId, purchaseOrder);
      setIsBulkModalOpen(false);
      setBulkEntries({});
      setPurchaseOrder('');
      setBulkBatchNumber(`BATCH-${Math.floor(1000 + Math.random() * 9000)}`);
    }
  };

  const openCatalogForNew = () => {
    setEditingProduct(null);
    setNewProductForm({
      id: '',
      name: '',
      brand: activeBrand,
      price: 0,
      unit: 'units',
      category: 'General',
      status: 'ACTIVE',
      observations: ''
    });
    setIsCatalogModalOpen(true);
  };

  const openCatalogForEdit = (product: Product) => {
    setEditingProduct(product);
    setNewProductForm({
      id: product.id,
      name: product.name,
      brand: product.brand,
      price: product.price,
      unit: product.unit,
      category: product.category,
      status: product.status,
      observations: product.observations || ''
    });
    setIsCatalogModalOpen(true);
  };

  const handleCatalogSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (!newProductForm.id || !newProductForm.name) {
      alert("ID and Name are required.");
      return;
    }

    if (!editingProduct) {
      if (!window.confirm(`Are you sure you want to register the new SKU: ${newProductForm.id}?`)) return;
    }

    if (editingProduct) {
      onUpdateProduct?.({ ...editingProduct, ...newProductForm } as Product);
    } else {
      if (products.some(p => p.id === newProductForm.id)) {
        alert("Product ID must be unique across all brands.");
        return;
      }
      onAddProduct?.(newProductForm);
    }
    setIsCatalogModalOpen(false);
  };

  const chartData = brandProducts.map(p => ({
    name: p.name.length > 15 ? p.name.substring(0, 12) + '...' : p.name,
    current: p.locationStocks[activeLocation.id] || 0,
    lastRestock: p.lastRestockAmount,
    unit: p.unit
  }));

  const brandColor = BRAND_HEX[activeBrand];
  const allEvents = brandProducts.flatMap(p => 
    p.history.map(log => ({ ...log, productName: p.name, productId: p.id }))
  ).sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

  const renderDetailedLogItem = (log: LogEntry) => {
    switch (log.type) {
      case 'RESTOCK':
        return (
          <div className="flex flex-col space-y-1">
            <span className="text-xs font-black text-emerald-600 uppercase tracking-widest">Stock Input</span>
            <div className="grid grid-cols-4 gap-2 text-sm">
              <div><span className="text-[10px] text-gray-400 uppercase block">Ref #</span> <span className="font-bold text-slate-700">{log.eventNumber}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Date</span> <span className="text-slate-600">{new Date(log.date).toLocaleDateString()}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Quantity</span> <span className="font-bold text-emerald-600">{log.quantity}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Site</span> <span className="font-bold text-slate-500 uppercase text-[10px]">{log.locationId || 'N/A'}</span></div>
            </div>
            <p className="text-[10px] text-gray-500 mt-1 italic">{log.change}</p>
          </div>
        );
      case 'SALE':
        return (
          <div className="flex flex-col space-y-1">
            <span className="text-xs font-black text-blue-600 uppercase tracking-widest">Sale / Out</span>
            <div className="grid grid-cols-4 gap-2 text-sm">
              <div><span className="text-[10px] text-gray-400 uppercase block">Event #</span> <span className="font-bold text-slate-700">{log.eventNumber}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Date</span> <span className="text-slate-600">{new Date(log.date).toLocaleDateString()}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Quantity</span> <span className="font-bold text-blue-600">{log.quantity}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Site</span> <span className="font-bold text-slate-500 uppercase text-[10px]">{log.locationId || 'N/A'}</span></div>
            </div>
            <p className="text-[10px] text-gray-500 mt-1 italic">{log.change}</p>
          </div>
        );
      case 'PRICE_CHANGE':
        return (
          <div className="flex flex-col space-y-1">
            <span className="text-xs font-black text-amber-600 uppercase tracking-widest">Price Change Event</span>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div><span className="text-[10px] text-gray-400 uppercase block">Event #</span> <span className="font-bold text-slate-700">{log.eventNumber}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Authorized By</span> <span className="font-bold text-slate-800">{log.authorizerName || log.userName}</span></div>
            </div>
            <p className="text-xs text-gray-500 mt-1 italic">{log.change}</p>
          </div>
        );
      case 'CATALOG_CREATE':
      case 'CATALOG_UPDATE':
        return (
          <div className="flex flex-col space-y-1">
            <span className={`text-xs font-black uppercase tracking-widest ${log.type === 'CATALOG_CREATE' ? 'text-indigo-600' : 'text-slate-600'}`}>
              {log.type === 'CATALOG_CREATE' ? 'Catalog Definition' : 'Catalog Update'}
            </span>
            <div className="grid grid-cols-2 gap-2 text-sm">
              <div><span className="text-[10px] text-gray-400 uppercase block">Event #</span> <span className="font-bold text-slate-700">{log.eventNumber}</span></div>
              <div><span className="text-[10px] text-gray-400 uppercase block">Author</span> <span className="font-bold text-slate-800">{log.authorizerName || log.userName}</span></div>
            </div>
            <p className="text-xs text-gray-500 mt-1 italic">{log.change}</p>
          </div>
        );
      default:
        return null;
    }
  };

  return (
    <div className="space-y-8">
      {/* Header with Stats */}
      <div className="flex justify-between items-center">
        <div>
          <h2 className="text-2xl font-bold text-gray-800">Inventory Management</h2>
          <p className="text-sm text-gray-500 flex items-center">
            <i className="fas fa-location-dot mr-1.5 text-emerald-600"></i>
            Managing levels for <span className="font-bold text-slate-900 mx-1">{activeBrand}</span> at <span className="font-bold text-emerald-600 ml-1">{activeLocation.name}</span>
          </p>
        </div>
        <div className="flex space-x-3">
          <button 
            onClick={openCatalogForNew}
            className="bg-white text-slate-900 border-2 border-slate-900 px-5 py-2.5 rounded-xl font-bold text-sm hover:bg-slate-50 transition-all flex items-center"
          >
            <i className="fas fa-book-open mr-2 text-indigo-500"></i>
            Catalog
          </button>
          <button 
            onClick={() => setIsBulkModalOpen(true)}
            className="bg-slate-900 text-white px-5 py-2.5 rounded-xl font-bold text-sm shadow-lg shadow-slate-200 hover:bg-slate-800 transition-all flex items-center"
          >
            <i className="fas fa-layer-group mr-2 text-emerald-400"></i>
            Bulk Entry
          </button>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div className="lg:col-span-2 bg-white p-6 rounded-2xl border border-gray-200 shadow-sm h-full">
          <div className="flex justify-between items-center mb-6">
            <h3 className="text-lg font-bold text-gray-800">Local Stock Levels</h3>
            <div className="flex items-center space-x-4 text-[10px] font-bold uppercase tracking-tight">
              <div className="flex items-center"><div className="w-2.5 h-2.5 rounded-sm mr-1" style={{backgroundColor: brandColor}}></div> Stock</div>
              <div className="flex items-center"><div className="w-2.5 h-2.5 rounded-sm mr-1" style={{backgroundColor: brandColor, opacity: 0.2}}></div> Restock</div>
            </div>
          </div>
          <div className="h-64">
            <ResponsiveContainer width="100%" height="100%">
              <BarChart data={chartData} margin={{ top: 10, right: 30, left: 0, bottom: 0 }} barGap={-20}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="name" axisLine={false} tickLine={false} tick={{fontSize: 10, fill: '#64748b'}} />
                <YAxis axisLine={false} tickLine={false} tick={{fontSize: 10, fill: '#64748b'}} />
                <Tooltip 
                  cursor={{fill: '#f8fafc'}} 
                  contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 15px -3px rgb(0 0 0 / 0.1)' }}
                />
                <Bar dataKey="lastRestock" radius={[4, 4, 0, 0]} barSize={32} fill={brandColor} fillOpacity={0.15} />
                <Bar dataKey="current" radius={[4, 4, 0, 0]} barSize={24} fill={brandColor} />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="bg-emerald-900 rounded-2xl p-6 text-white shadow-xl shadow-emerald-900/20 flex flex-col justify-between">
           <div>
              <div className="flex items-center space-x-2 mb-4">
                <i className="fas fa-boxes text-emerald-400"></i>
                <h3 className="font-bold text-lg">Site Health</h3>
              </div>
              <p className="text-emerald-100/70 text-sm leading-relaxed mb-6">
                Active monitoring of stock at <span className="font-bold text-white">{activeLocation.name}</span>.
              </p>
              <div className="space-y-4">
                 <div className="flex items-center justify-between bg-white/10 p-3 rounded-xl">
                    <span className="text-xs">Capacity Utilization</span>
                    <span className="text-sm font-bold">68%</span>
                 </div>
                 <div className="flex items-center justify-between bg-white/10 p-3 rounded-xl">
                    <span className="text-xs">Out of Stock Risk</span>
                    <span className="text-sm font-bold text-red-300">Moderate</span>
                 </div>
              </div>
           </div>
           <button className="mt-8 w-full bg-emerald-500 hover:bg-emerald-400 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-emerald-500/20 text-sm">
             Generate Site Inventory List
           </button>
        </div>
      </div>

      {/* Main Events Table */}
      <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm">
        <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/30">
           <h3 className="text-lg font-bold text-gray-800">Operational History</h3>
        </div>
        <table className="w-full text-left border-collapse">
          <thead className="bg-gray-50/50 border-b border-gray-200">
            <tr>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest">Product Info</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest">Type</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-center">Location</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-right">Qty</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-right">Date</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {allEvents.length === 0 ? (
               <tr>
                 <td colSpan={5} className="px-6 py-10 text-center text-gray-400 text-sm italic">No operations recorded yet.</td>
               </tr>
            ) : (
              allEvents.map((log) => (
                <tr key={log.id} className="hover:bg-gray-50/50 transition-colors">
                  <td className="px-6 py-4">
                    <p className="text-sm font-bold text-gray-900">{(log as any).productName}</p>
                    <p className="text-[10px] text-gray-400 uppercase font-medium"># {(log as any).productId}</p>
                  </td>
                  <td className="px-6 py-4">
                    <span className={`inline-flex items-center px-2 py-0.5 rounded text-[10px] font-black uppercase ${
                      log.type === 'RESTOCK' ? 'bg-emerald-50 text-emerald-700' : 
                      log.type === 'SALE' ? 'bg-blue-50 text-blue-700' : 'bg-slate-50 text-slate-700'
                    }`}>
                      {log.type}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-center">
                    <span className="text-[10px] font-black text-slate-400 uppercase">{log.locationId || 'Global'}</span>
                  </td>
                  <td className="px-6 py-4 text-right">
                    <span className={`text-sm font-bold ${log.type === 'RESTOCK' ? 'text-emerald-600' : log.type === 'SALE' ? 'text-blue-600' : 'text-slate-600'}`}>
                      {log.quantity || '-'}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-right">
                    <p className="text-sm text-slate-600">{new Date(log.date).toLocaleDateString()}</p>
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>

      {/* Master Product List */}
      <div className="bg-white rounded-2xl border border-gray-200 overflow-hidden shadow-sm mt-12">
        <div className="p-6 border-b border-gray-100">
           <h3 className="text-lg font-bold text-gray-800">Site Stock Ledger</h3>
        </div>
        <table className="w-full text-left border-collapse">
          <thead className="bg-gray-50/50 border-b border-gray-200">
            <tr>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest">Product</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-center">Local Stock</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-right">Price</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase tracking-widest text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {brandProducts.map(product => {
              const localStock = product.locationStocks[activeLocation.id] || 0;
              return (
              <tr key={product.id} className="hover:bg-gray-50/50 transition-colors group">
                <td className="px-6 py-5">
                  <p className="text-sm font-bold text-gray-900">{product.name}</p>
                  <p className="text-[10px] text-gray-400 uppercase font-medium">{product.category}</p>
                </td>
                <td className="px-6 py-5 text-center">
                  {editingId === product.id && editType === 'stock' ? (
                    <div className="flex items-center justify-center space-x-2">
                      <input 
                        type="number" 
                        className="w-20 p-1.5 border-2 border-emerald-500 rounded-lg text-center outline-none"
                        value={editValue}
                        onChange={(e) => setEditValue(parseFloat(e.target.value))}
                        autoFocus
                      />
                      <button onClick={saveInlineEdit} className="w-8 h-8 flex items-center justify-center bg-emerald-500 text-white rounded-lg"><i className="fas fa-check"></i></button>
                    </div>
                  ) : (
                    <span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-bold ${localStock < 100 ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>
                      {localStock} {product.unit}
                    </span>
                  )}
                </td>
                <td className="px-6 py-5 text-right font-extrabold text-gray-900">
                  ${product.price.toFixed(2)}
                </td>
                <td className="px-6 py-5 text-right space-x-2">
                  <button onClick={() => setHistoryProduct(product)} className="p-2 text-slate-400 hover:text-slate-600"><i className="fas fa-history"></i></button>
                  <button onClick={() => handleEditStockOrPrice(product, 'stock')} className="p-2 text-emerald-500 hover:bg-emerald-50 rounded"><i className="fas fa-plus"></i></button>
                </td>
              </tr>
            )})}
          </tbody>
        </table>
      </div>

      {/* Bulk Modal */}
      {isBulkModalOpen && (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-[150] p-4">
          <div className="bg-white rounded-[2rem] w-full max-w-5xl h-[85vh] flex flex-col shadow-2xl overflow-hidden border border-slate-200">
            <div className="p-8 border-b border-gray-100 flex flex-col gap-4 bg-gray-50/50">
              <div className="flex justify-between items-center">
                <div>
                  <h3 className="text-2xl font-black text-slate-900">Bulk Entry - Destination: {activeLocation.name}</h3>
                  <p className="text-sm text-gray-500 font-medium">Add units by restock or internal transfer from another site</p>
                </div>
                <button onClick={() => setIsBulkModalOpen(false)} className="text-gray-400 hover:text-gray-900">
                  <i className="fas fa-times text-2xl"></i>
                </button>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 items-end">
                {/* Source Selection */}
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Input Source Type</label>
                  <select 
                    className="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:border-emerald-500 font-bold transition-all"
                    value={bulkSourceId}
                    onChange={(e) => setBulkSourceId(e.target.value)}
                  >
                    <option value="restock">External Restock (Purchase)</option>
                    {LOCATIONS.filter(l => l.id !== activeLocation.id).map(l => (
                      <option key={l.id} value={l.id}>Transfer from: {l.name}</option>
                    ))}
                  </select>
                </div>

                {/* Conditional Purchase Order Input */}
                {bulkSourceId === 'restock' && (
                  <div>
                    <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Purchase Order #</label>
                    <div className="relative">
                      <i className="fas fa-hashtag absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
                      <input 
                        required
                        type="text"
                        placeholder="e.g. PO-DRG-001"
                        className="w-full bg-white border-2 border-emerald-200 rounded-xl pl-11 pr-4 py-2.5 outline-none focus:border-emerald-500 font-bold transition-all text-emerald-900"
                        value={purchaseOrder}
                        onChange={(e) => setPurchaseOrder(e.target.value)}
                      />
                    </div>
                  </div>
                )}

                {/* Batch Reference (Static or Shared) */}
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2">Batch/Reference ID</label>
                  <input 
                    type="text" 
                    className="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-2.5 outline-none focus:border-emerald-500 font-bold"
                    value={bulkBatchNumber}
                    onChange={(e) => setBulkBatchNumber(e.target.value)}
                  />
                </div>
              </div>
            </div>
            
            <div className="flex-1 overflow-y-auto p-8 pt-4">
              <table className="w-full text-left">
                <thead className="sticky top-0 bg-white z-10">
                  <tr className="border-b border-gray-200">
                    <th className="pb-4 text-[10px] font-bold text-gray-500 uppercase">Product</th>
                    <th className="pb-4 text-[10px] font-bold text-gray-500 uppercase text-center">Current Target Stock</th>
                    {bulkSourceId !== 'restock' && (
                      <th className="pb-4 text-[10px] font-bold text-emerald-600 uppercase text-center">Source Site Stock</th>
                    )}
                    <th className="pb-4 text-[10px] font-bold text-gray-500 uppercase text-right">Units to Add (+)</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-50">
                  {products.map(p => (
                    <tr key={p.id} className="hover:bg-slate-50 transition-colors">
                      <td className="py-4">
                        <p className="text-sm font-bold text-slate-900">{p.name}</p>
                        <p className="text-[10px] uppercase text-gray-400 font-black">{p.brand}  {p.unit}</p>
                      </td>
                      <td className="py-4 text-center">
                        <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">
                          {p.locationStocks[activeLocation.id] || 0}
                        </span>
                      </td>
                      {bulkSourceId !== 'restock' && (
                        <td className="py-4 text-center">
                          <span className={`text-xs font-black px-2 py-1 rounded ${
                            (p.locationStocks[bulkSourceId] || 0) > 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-red-50 text-red-700'
                          }`}>
                            {p.locationStocks[bulkSourceId] || 0}
                          </span>
                        </td>
                      )}
                      <td className="py-4 text-right">
                        <input 
                          type="number" 
                          min="0"
                          placeholder="0"
                          className="w-24 bg-white border-2 border-gray-200 rounded-xl p-2 outline-none focus:border-emerald-500 font-bold transition-all text-center"
                          value={bulkEntries[p.id]?.addedStock || ''}
                          onChange={(e) => handleBulkEntryChange(p.id, 'addedStock', parseFloat(e.target.value) || 0)}
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="p-8 border-t border-gray-100 flex justify-between items-center bg-slate-50/50">
               <div className="text-xs font-bold text-slate-500">
                  Updates to process: <span className="text-slate-900 font-black">{Object.keys(bulkEntries).filter(k => bulkEntries[k].addedStock > 0).length} items</span>
               </div>
               <div className="flex space-x-4">
                <button onClick={() => setIsBulkModalOpen(false)} className="px-6 py-3 text-slate-500 font-bold hover:text-slate-900">Discard</button>
                <button 
                  onClick={handleBulkSubmit} 
                  className="bg-slate-900 text-white px-10 py-3 rounded-2xl font-black text-sm shadow-xl shadow-slate-900/20 hover:bg-slate-800 transition-all"
                >
                  {bulkSourceId === 'restock' ? 'Execute Purchase Restock' : 'Process Site Transfer'}
                </button>
               </div>
            </div>
          </div>
        </div>
      )}

      {/* Catalog Modal */}
      {isCatalogModalOpen && (
        <div className="fixed inset-0 bg-slate-900/70 backdrop-blur-md flex items-center justify-center z-[150] p-4">
          <div className="bg-white rounded-3xl w-full max-w-2xl overflow-hidden shadow-2xl">
            <div className="p-8 border-b border-gray-100 flex justify-between items-center bg-indigo-50/20">
              <h3 className="text-2xl font-black text-slate-900">{editingProduct ? 'Edit Global Catalog' : 'New Catalog Definition'}</h3>
              <button onClick={() => setIsCatalogModalOpen(false)} className="text-slate-400 hover:text-slate-900"><i className="fas fa-times text-2xl"></i></button>
            </div>
            <form onSubmit={handleCatalogSubmit} className="p-8 space-y-6">
              <div className="grid grid-cols-2 gap-6">
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">SKU ID (Unique)</label>
                  <input required readOnly={!!editingProduct} type="text" className="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold" value={newProductForm.id} onChange={(e) => setNewProductForm({...newProductForm, id: e.target.value})} />
                </div>
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Display Name</label>
                  <input required type="text" className="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold" value={newProductForm.name} onChange={(e) => setNewProductForm({...newProductForm, name: e.target.value})} />
                </div>
              </div>
              <div className="grid grid-cols-2 gap-6">
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Brand Portfolio</label>
                  <select className="w-full p-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold" value={newProductForm.brand} onChange={(e) => setNewProductForm({...newProductForm, brand: e.target.value as Brand})}>
                    {BRANDS.map(b => <option key={b} value={b}>{b}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-[10px] font-black text-slate-500 uppercase tracking-widest mb-1">Master Unit Price</label>
                  <div className="relative">
                    <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold">$</span>
                    <input required type="number" step="0.01" className="w-full pl-8 pr-4 py-3 bg-slate-50 border-2 border-slate-100 rounded-xl outline-none focus:border-indigo-500 font-bold" value={newProductForm.price} onChange={(e) => setNewProductForm({...newProductForm, price: parseFloat(e.target.value) || 0})} />
                  </div>
                </div>
              </div>
              <div className="flex justify-end space-x-4 pt-6 border-t border-slate-100">
                <button type="button" onClick={() => setIsCatalogModalOpen(false)} className="px-6 py-3 font-bold text-slate-400">Cancel</button>
                <button type="submit" className="bg-slate-900 text-white px-10 py-3 rounded-2xl font-black text-sm shadow-xl shadow-slate-900/20">
                  {editingProduct ? 'Commit Changes' : 'Register Catalog Item'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* History Modal */}
      {historyProduct && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
          <div className="bg-white rounded-3xl max-w-2xl w-full max-h-[85vh] flex flex-col shadow-2xl overflow-hidden">
            <div className="p-6 border-b border-gray-100 flex justify-between items-center bg-gray-50/50">
              <div>
                <h3 className="text-xl font-bold text-slate-900">{historyProduct.name}</h3>
                <p className="text-xs text-slate-400 font-bold uppercase tracking-widest">Global Supply Chain Audit</p>
              </div>
              <button onClick={() => setHistoryProduct(null)} className="text-slate-400 hover:text-slate-900 transition-colors">
                <i className="fas fa-times text-xl"></i>
              </button>
            </div>
            <div className="flex-1 overflow-y-auto p-6 space-y-4">
              {historyProduct.history.length === 0 ? (
                <div className="text-center py-20 text-slate-300 font-medium italic">No ledger entries for this SKU yet.</div>
              ) : (
                historyProduct.history.slice().reverse().map(log => (
                  <div key={log.id} className="bg-slate-50 p-5 rounded-2xl border border-slate-100 hover:shadow-sm transition-shadow">
                    {renderDetailedLogItem(log)}
                  </div>
                ))
              )}
            </div>
            <div className="p-6 bg-slate-50 border-t border-slate-200 text-right">
              <button onClick={() => setHistoryProduct(null)} className="bg-slate-900 text-white px-8 py-2.5 rounded-xl font-bold text-sm">Close Audit Log</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default Inventory;
</file>

<file path="components/Layout.tsx">
import React, { useState } from 'react';
import { Role, Brand, User, Location } from '../types';
import { BRANDS, BRAND_COLORS, LOCATIONS } from '../constants';

interface LayoutProps {
  children: React.ReactNode;
  user: User;
  onLogout: () => void;
  activeBrand: Brand;
  setActiveBrand: (brand: Brand) => void;
  activeLocation: Location;
  setActiveLocation: (location: Location) => void;
  currentView: string;
  setCurrentView: (view: string) => void;
}

const Layout: React.FC<LayoutProps> = ({ 
  children, 
  user, 
  onLogout, 
  activeBrand, 
  setActiveBrand,
  activeLocation,
  setActiveLocation,
  currentView,
  setCurrentView
}) => {
  const [sidebarOpen, setSidebarOpen] = useState(true);

  const menuItems = [
    { id: 'dashboard', label: 'Dashboard', icon: 'fa-chart-line', roles: [Role.ADMIN, Role.MANAGER, Role.EMPLOYEE] },
    { id: 'orders', label: 'Orders & Sales', icon: 'fa-shopping-cart', roles: [Role.ADMIN, Role.MANAGER, Role.EMPLOYEE] },
    { id: 'inventory', label: 'Inventory', icon: 'fa-boxes-stacked', roles: [Role.ADMIN, Role.MANAGER] },
    { id: 'reports', label: 'Reports', icon: 'fa-file-invoice-dollar', roles: [Role.ADMIN, Role.MANAGER] },
    { id: 'employees', label: 'Employees', icon: 'fa-users-gear', roles: [Role.ADMIN] },
  ];

  const filteredMenu = menuItems.filter(item => item.roles.includes(user.role));

  return (
    <div className="flex h-screen overflow-hidden bg-gray-50">
      {/* Sidebar */}
      <aside className={`${sidebarOpen ? 'w-64' : 'w-20'} transition-all duration-300 bg-slate-900 text-white flex flex-col no-print`}>
        <div className="p-4 flex items-center justify-between border-b border-slate-700">
          <span className={`font-bold text-xl truncate ${!sidebarOpen && 'hidden'}`}>Don Rafa Group</span>
          <button onClick={() => setSidebarOpen(!sidebarOpen)} className="p-1 hover:bg-slate-700 rounded">
            <i className={`fas ${sidebarOpen ? 'fa-angle-double-left' : 'fa-bars'}`}></i>
          </button>
        </div>

        <nav className="flex-1 mt-4 px-2 space-y-1">
          {filteredMenu.map((item) => (
            <button
              key={item.id}
              onClick={() => setCurrentView(item.id)}
              className={`w-full flex items-center p-3 rounded-lg transition-colors ${
                currentView === item.id ? 'bg-emerald-600' : 'hover:bg-slate-800'
              }`}
            >
              <i className={`fas ${item.icon} w-6 text-center`}></i>
              {sidebarOpen && <span className="ml-3 font-medium">{item.label}</span>}
            </button>
          ))}
        </nav>

        <div className="p-4 border-t border-slate-700">
          <button onClick={onLogout} className="w-full flex items-center p-3 hover:bg-red-900/40 text-red-400 rounded-lg transition-colors">
            <i className="fas fa-sign-out-alt w-6 text-center"></i>
            {sidebarOpen && <span className="ml-3 font-medium">Logout</span>}
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 flex flex-col overflow-hidden">
        {/* Navbar */}
        <header className="h-16 bg-white border-b border-gray-200 flex items-center justify-between px-6 no-print">
          <div className="flex items-center space-x-4">
            <h2 className="text-lg font-semibold text-gray-800 capitalize">{currentView}</h2>
            
            <div className="flex bg-gray-100 p-1 rounded-lg">
              {user.brands.map(brand => (
                <button
                  key={brand}
                  onClick={() => setActiveBrand(brand)}
                  className={`px-3 py-1 rounded-md text-sm font-medium transition-all ${
                    activeBrand === brand 
                    ? `${BRAND_COLORS[brand]} text-white shadow-sm` 
                    : 'text-gray-500 hover:text-gray-700'
                  }`}
                >
                  {brand}
                </button>
              ))}
            </div>
          </div>

          <div className="flex items-center space-x-6">
            {/* Location Switcher */}
            <div className="relative group">
              <div className="flex items-center space-x-2 bg-slate-50 border border-slate-200 px-3 py-1.5 rounded-full hover:border-emerald-500 transition-colors cursor-pointer">
                <i className="fas fa-warehouse text-emerald-600 text-xs"></i>
                <span className="text-xs font-bold text-slate-700">{activeLocation.name}</span>
                <i className="fas fa-chevron-down text-[10px] text-slate-400"></i>
              </div>
              
              <div className="absolute top-full right-0 mt-2 w-64 bg-white border border-slate-200 rounded-2xl shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100] p-2">
                <p className="px-4 py-2 text-[10px] font-black text-slate-400 uppercase tracking-widest">Select Operational Site</p>
                {LOCATIONS.map(loc => (
                  <button
                    key={loc.id}
                    onClick={() => setActiveLocation(loc)}
                    className={`w-full text-left px-4 py-3 rounded-xl transition-all flex flex-col ${
                      activeLocation.id === loc.id ? 'bg-emerald-50 text-emerald-700' : 'hover:bg-slate-50 text-slate-600'
                    }`}
                  >
                    <span className="text-sm font-bold">{loc.name}</span>
                    <span className="text-[10px] opacity-70 truncate">{loc.address}</span>
                  </button>
                ))}
              </div>
            </div>

            {/* Profile Info */}
            <div className="flex items-center space-x-4">
              <div className="text-right hidden sm:block">
                <p className="text-sm font-bold text-gray-900 leading-tight">{user.name}</p>
                <p className="text-xs text-gray-500 capitalize">{user.role.toLowerCase()}</p>
              </div>
              <div className="h-10 w-10 bg-emerald-100 text-emerald-700 flex items-center justify-center rounded-full font-bold border-2 border-white shadow-sm">
                {user.name.charAt(0)}
              </div>
            </div>
          </div>
        </header>

        {/* View Port */}
        <div className="flex-1 overflow-y-auto p-6">
          {children}
        </div>
      </main>
    </div>
  );
};

export default Layout;
</file>

<file path="components/Orders.tsx">
import React, { useState } from 'react';
import { Order, OrderStatus, Brand, Product, User, Role, OrderItem, Location } from '../types';

interface OrdersProps {
  orders: Order[];
  products: Product[];
  currentUser: User;
  activeBrand: Brand;
  // Added activeLocation to match props passed in App.tsx
  activeLocation: Location;
  onUpdateStatus: (orderId: string, status: OrderStatus) => void;
  onCreateOrder: (order: Partial<Order>) => void;
}

const Orders: React.FC<OrdersProps> = ({ orders, products, currentUser, activeBrand, activeLocation, onUpdateStatus, onCreateOrder }) => {
  const [showCreate, setShowCreate] = useState(false);
  const [showQuote, setShowQuote] = useState<Order | null>(null);
  
  const [newOrder, setNewOrder] = useState({
    clientName: '',
    clientEmail: '',
    items: [] as OrderItem[]
  });

  const filteredOrders = orders.filter(o => o.brand === activeBrand);
  const brandProducts = products.filter(p => p.brand === activeBrand);

  const addItem = () => {
    setNewOrder({
      ...newOrder,
      items: [...newOrder.items, { productId: '', productName: '', quantity: 1, unitPrice: 0 }]
    });
  };

  const handleItemChange = (index: number, field: string, value: any) => {
    const updatedItems = [...newOrder.items];
    if (field === 'productId') {
      const prod = brandProducts.find(p => p.id === value);
      updatedItems[index] = { 
        ...updatedItems[index], 
        productId: value, 
        productName: prod?.name || '', 
        unitPrice: prod?.price || 0 
      };
    } else {
      updatedItems[index] = { ...updatedItems[index], [field]: value };
    }
    setNewOrder({ ...newOrder, items: updatedItems });
  };

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (newOrder.items.length === 0) return;
    
    const total = newOrder.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
    
    onCreateOrder({
      ...newOrder,
      brand: activeBrand,
      status: OrderStatus.PENDING,
      total
    });
    setShowCreate(false);
    setNewOrder({ clientName: '', clientEmail: '', items: [] });
  };

  const getStatusColor = (status: OrderStatus) => {
    switch (status) {
      case OrderStatus.PENDING: return 'bg-amber-100 text-amber-800';
      case OrderStatus.CONFIRMED: return 'bg-blue-100 text-blue-800';
      case OrderStatus.PAID: return 'bg-emerald-100 text-emerald-800';
      case OrderStatus.PRODUCTION: return 'bg-purple-100 text-purple-800';
      case OrderStatus.SHIPPED: return 'bg-indigo-100 text-indigo-800';
      case OrderStatus.REJECTED: return 'bg-red-100 text-red-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  if (showQuote) {
    return (
      <div className="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden print:shadow-none print:border-0">
        <div className="p-8 no-print border-b border-gray-100 flex justify-between items-center bg-gray-50">
          <button onClick={() => setShowQuote(null)} className="text-gray-500 hover:text-gray-800">
            <i className="fas fa-arrow-left mr-2"></i> Back to Orders
          </button>
          <div className="flex space-x-2">
             <button onClick={() => window.print()} className="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700">
               <i className="fas fa-print mr-2"></i> Print / PDF
             </button>
          </div>
        </div>

        <div className="p-12 space-y-8 print:p-0">
          <div className="flex justify-between items-start">
            <div>
              <h1 className="text-3xl font-bold text-gray-900">{showQuote.brand}</h1>
              <p className="text-gray-500 mt-1 uppercase tracking-widest text-xs">Official Quotation</p>
            </div>
            <div className="text-right">
              <p className="text-lg font-bold">#{showQuote.id}</p>
              <p className="text-gray-500">{new Date(showQuote.createdAt).toLocaleDateString()}</p>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-12 border-y border-gray-100 py-8">
            <div>
              <p className="text-xs font-bold text-gray-400 uppercase mb-2">From</p>
              <p className="font-bold">{showQuote.brand} Office</p>
              <p className="text-gray-600">Southern Chiapas Industrial Park</p>
              <p className="text-gray-600">Mexico</p>
            </div>
            <div>
              <p className="text-xs font-bold text-gray-400 uppercase mb-2">Bill To</p>
              <p className="font-bold">{showQuote.clientName}</p>
              <p className="text-gray-600">{showQuote.clientEmail}</p>
            </div>
          </div>

          <table className="w-full text-left">
            <thead>
              <tr className="border-b border-gray-200 text-xs font-bold text-gray-400 uppercase">
                <th className="py-4">Description</th>
                <th className="py-4 text-center">Qty</th>
                <th className="py-4 text-right">Unit Price</th>
                <th className="py-4 text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              {showQuote.items.map((item, idx) => (
                <tr key={idx} className="border-b border-gray-50">
                  <td className="py-4">{item.productName}</td>
                  <td className="py-4 text-center">{item.quantity}</td>
                  <td className="py-4 text-right">${item.unitPrice.toFixed(2)}</td>
                  <td className="py-4 text-right font-medium">${(item.quantity * item.unitPrice).toFixed(2)}</td>
                </tr>
              ))}
            </tbody>
            <tfoot>
              <tr>
                <td colSpan={3} className="pt-8 text-right font-bold text-gray-900">Total Amount Due</td>
                <td className="pt-8 text-right font-bold text-2xl text-emerald-600">${showQuote.total.toFixed(2)}</td>
              </tr>
            </tfoot>
          </table>

          <div className="pt-12 text-center text-gray-400 text-xs italic">
            This is a computer-generated quote and valid for 30 days.
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-bold text-gray-800">Sales Orders</h2>
        <button 
          onClick={() => setShowCreate(true)}
          className="bg-emerald-600 text-white px-4 py-2 rounded-lg hover:bg-emerald-700 flex items-center shadow-md transition-all"
        >
          <i className="fas fa-plus mr-2"></i> New Order
        </button>
      </div>

      {showCreate && (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl max-w-2xl w-full p-6 shadow-2xl">
            <h3 className="text-xl font-bold mb-6">Create New Sales Order</h3>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                  <input 
                    required 
                    type="text" 
                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
                    value={newOrder.clientName}
                    onChange={(e) => setNewOrder({...newOrder, clientName: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">Client Email</label>
                  <input 
                    required 
                    type="email" 
                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-emerald-500 focus:border-emerald-500"
                    value={newOrder.clientEmail}
                    onChange={(e) => setNewOrder({...newOrder, clientEmail: e.target.value})}
                  />
                </div>
              </div>

              <div className="space-y-3">
                <div className="flex justify-between items-center">
                  <h4 className="font-bold text-gray-700">Order Items</h4>
                  <button type="button" onClick={addItem} className="text-sm text-emerald-600 hover:underline">
                    + Add Product
                  </button>
                </div>
                {newOrder.items.map((item, idx) => (
                  <div key={idx} className="grid grid-cols-12 gap-2 items-end">
                    <div className="col-span-6">
                      <select 
                        required
                        className="w-full p-2 border border-gray-300 rounded-md text-sm"
                        value={item.productId}
                        onChange={(e) => handleItemChange(idx, 'productId', e.target.value)}
                      >
                        <option value="">Select Product</option>
                        {brandProducts.map(p => (
                          <option key={p.id} value={p.id}>{p.name} (${p.price}/{p.unit})</option>
                        ))}
                      </select>
                    </div>
                    <div className="col-span-3">
                      <input 
                        type="number" 
                        min="1" 
                        placeholder="Qty"
                        className="w-full p-2 border border-gray-300 rounded-md text-sm"
                        value={item.quantity}
                        onChange={(e) => handleItemChange(idx, 'quantity', parseInt(e.target.value))}
                      />
                    </div>
                    <div className="col-span-2">
                      <p className="text-sm py-2 font-bold">${(item.quantity * item.unitPrice).toFixed(0)}</p>
                    </div>
                    <div className="col-span-1">
                      <button 
                        type="button" 
                        onClick={() => setNewOrder({...newOrder, items: newOrder.items.filter((_, i) => i !== idx)})}
                        className="text-red-500 p-2"
                      >
                        <i className="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                ))}
              </div>

              <div className="flex justify-end space-x-3 pt-6 border-t mt-6">
                <button type="button" onClick={() => setShowCreate(false)} className="px-4 py-2 text-gray-600">Cancel</button>
                <button type="submit" className="px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700">Create Order</button>
              </div>
            </form>
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl border border-gray-200 overflow-hidden shadow-sm">
        <table className="w-full text-left">
          <thead className="bg-gray-50 border-b border-gray-200">
            <tr>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase">ID</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Client</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Amount</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Status</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase">Date</th>
              <th className="px-6 py-4 text-xs font-bold text-gray-500 uppercase text-right">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {filteredOrders.length === 0 ? (
              <tr>
                <td colSpan={6} className="px-6 py-10 text-center text-gray-500">No orders found for this brand.</td>
              </tr>
            ) : (
              filteredOrders.map(order => (
                <tr key={order.id} className="hover:bg-gray-50 transition-colors">
                  <td className="px-6 py-4 font-bold text-gray-900">{order.id}</td>
                  <td className="px-6 py-4">
                    <p className="text-sm font-medium text-gray-900">{order.clientName}</p>
                    <p className="text-xs text-gray-500">{order.clientEmail}</p>
                  </td>
                  <td className="px-6 py-4 text-sm font-bold text-gray-900">${order.total.toLocaleString()}</td>
                  <td className="px-6 py-4">
                    <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${getStatusColor(order.status)}`}>
                      {order.status}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500">{new Date(order.createdAt).toLocaleDateString()}</td>
                  <td className="px-6 py-4 text-right space-x-2">
                    <button 
                      onClick={() => setShowQuote(order)}
                      className="p-2 text-blue-600 hover:bg-blue-50 rounded" 
                      title="View Quote"
                    >
                      <i className="fas fa-file-invoice"></i>
                    </button>
                    
                    {(currentUser.role === Role.ADMIN || currentUser.role === Role.MANAGER) && order.status === OrderStatus.PENDING && (
                      <>
                        <button 
                          onClick={() => onUpdateStatus(order.id, OrderStatus.CONFIRMED)}
                          className="p-2 text-emerald-600 hover:bg-emerald-50 rounded" 
                          title="Approve"
                        >
                          <i className="fas fa-check"></i>
                        </button>
                        <button 
                          onClick={() => onUpdateStatus(order.id, OrderStatus.REJECTED)}
                          className="p-2 text-red-600 hover:bg-red-50 rounded" 
                          title="Reject"
                        >
                          <i className="fas fa-times"></i>
                        </button>
                      </>
                    )}

                    {(currentUser.role === Role.ADMIN || currentUser.role === Role.MANAGER) && order.status === OrderStatus.CONFIRMED && (
                      <button 
                        onClick={() => onUpdateStatus(order.id, OrderStatus.PAID)}
                        className="p-2 text-indigo-600 hover:bg-indigo-50 rounded" 
                        title="Mark Paid"
                      >
                        <i className="fas fa-hand-holding-dollar"></i>
                      </button>
                    )}
                  </td>
                </tr>
              ))
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};

export default Orders;
</file>

<file path="components/Reports.tsx">
import React, { useState, useEffect } from 'react';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, AreaChart, Area } from 'recharts';
import { Brand, Order, Product } from '../types';
import { getReportInsights } from '../services/geminiService';

interface ReportsProps {
  orders: Order[];
  products: Product[];
  activeBrand: Brand;
}

const Reports: React.FC<ReportsProps> = ({ orders, products, activeBrand }) => {
  const [period, setPeriod] = useState<'daily' | 'weekly' | 'monthly' | 'yearly'>('weekly');
  const [insights, setInsights] = useState<string[]>([]);
  const [loading, setLoading] = useState(false);

  const fetchDataInsights = async () => {
    setLoading(true);
    // Fixed: Property 'stock' does not exist on type 'Product'. Summing locationStocks to get total stock for the brand report.
    const brandData = {
      brand: activeBrand,
      period,
      totalSales: orders.filter(o => o.brand === activeBrand).length,
      revenue: orders.filter(o => o.brand === activeBrand).reduce((s, o) => s + o.total, 0),
      lowStockItems: products.filter(p => p.brand === activeBrand && Object.values(p.locationStocks).reduce((sum, qty) => sum + qty, 0) < 100).length
    };
    const res = await getReportInsights(brandData);
    setInsights(res);
    setLoading(false);
  };

  useEffect(() => {
    fetchDataInsights();
  }, [activeBrand, period]);

  const data = [
    { name: 'Jan', revenue: 45000, orders: 240 },
    { name: 'Feb', revenue: 52000, orders: 300 },
    { name: 'Mar', revenue: 48000, orders: 280 },
    { name: 'Apr', revenue: 61000, orders: 350 },
    { name: 'May', revenue: 55000, orders: 310 },
    { name: 'Jun', revenue: 67000, orders: 390 },
  ];

  return (
    <div className="space-y-6">
      <div className="flex justify-between items-center">
        <h2 className="text-xl font-bold text-gray-800">Operational Reports</h2>
        <div className="flex bg-white rounded-lg border border-gray-200 p-1">
          {(['daily', 'weekly', 'monthly', 'yearly'] as const).map(p => (
            <button
              key={p}
              onClick={() => setPeriod(p)}
              className={`px-4 py-1.5 rounded-md text-sm font-medium capitalize transition-all ${
                period === p ? 'bg-emerald-600 text-white shadow' : 'text-gray-500 hover:text-gray-700'
              }`}
            >
              {p}
            </button>
          ))}
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-96">
            <h3 className="font-bold text-gray-800 mb-6">Revenue Trend</h3>
            <ResponsiveContainer width="100%" height="100%">
              <AreaChart data={data}>
                <defs>
                  <linearGradient id="colorRev" x1="0" y1="0" x2="0" y2="1">
                    <stop offset="5%" stopColor="#10b981" stopOpacity={0.1}/>
                    <stop offset="95%" stopColor="#10b981" stopOpacity={0}/>
                  </linearGradient>
                </defs>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                <YAxis axisLine={false} tickLine={false} />
                <Tooltip />
                <Area type="monotone" dataKey="revenue" stroke="#10b981" fillOpacity={1} fill="url(#colorRev)" strokeWidth={2} />
              </AreaChart>
            </ResponsiveContainer>
          </div>

          <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm h-64">
            <h3 className="font-bold text-gray-800 mb-6">Order Volume</h3>
            <ResponsiveContainer width="100%" height="100%">
              <LineChart data={data}>
                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f1f5f9" />
                <XAxis dataKey="name" axisLine={false} tickLine={false} />
                <YAxis axisLine={false} tickLine={false} />
                <Tooltip />
                <Line type="stepAfter" dataKey="orders" stroke="#3b82f6" strokeWidth={2} dot={{ r: 4, fill: '#3b82f6' }} />
              </LineChart>
            </ResponsiveContainer>
          </div>
        </div>

        <div className="space-y-6">
          <div className="bg-emerald-900 text-white p-6 rounded-xl shadow-lg relative overflow-hidden">
            <div className="relative z-10">
              <div className="flex items-center space-x-2 mb-4">
                <i className="fas fa-brain text-emerald-400"></i>
                <h3 className="font-bold text-lg">AI Business Insights</h3>
              </div>
              
              {loading ? (
                <div className="flex items-center space-x-3 text-emerald-300 animate-pulse">
                  <i className="fas fa-spinner fa-spin"></i>
                  <span>Analyzing numbers...</span>
                </div>
              ) : (
                <ul className="space-y-4">
                  {insights.map((insight, idx) => (
                    <li key={idx} className="flex items-start space-x-3">
                      <i className="fas fa-lightbulb text-emerald-400 mt-1 shrink-0"></i>
                      <p className="text-sm text-emerald-50 leading-relaxed">{insight}</p>
                    </li>
                  ))}
                </ul>
              )}
            </div>
            <div className="absolute top-0 right-0 -mr-8 -mt-8 w-32 h-32 bg-emerald-800 rounded-full blur-3xl opacity-50"></div>
          </div>

          <div className="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
            <h3 className="font-bold text-gray-800 mb-4">Quick Stats</h3>
            <div className="space-y-4">
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-500">Avg. Order Value</span>
                <span className="font-bold text-gray-900">$245.00</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-500">Order Growth</span>
                <span className="font-bold text-emerald-600">+12.5%</span>
              </div>
              <div className="flex justify-between items-center">
                <span className="text-sm text-gray-500">Fulfillment Rate</span>
                <span className="font-bold text-gray-900">98%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default Reports;
</file>

<file path="constants.tsx">
import { Brand, Permission, Role, OrderStatus, Product, User, Order, Location } from './types';

export const BRANDS: Brand[] = ['Finca Don Rafa', 'Yuteco', 'Ecotact'];

export const LOCATIONS: Location[] = [
  { id: 'loc-1', name: 'Main Warehouse (Chiapas)', address: 'Industrial Zone, Chiapas' },
  { id: 'loc-2', name: 'Distribution Center (Mexico City)', address: 'Central North, CDMX' },
  { id: 'loc-3', name: 'Retail Store (Tapachula)', address: 'Main Ave, Tapachula' }
];

export const BRAND_COLORS: Record<Brand, string> = {
  'Finca Don Rafa': 'bg-emerald-600',
  'Yuteco': 'bg-amber-600',
  'Ecotact': 'bg-sky-600',
};

export const BRAND_HEX: Record<Brand, string> = {
  'Finca Don Rafa': '#059669',
  'Yuteco': '#d97706',
  'Ecotact': '#0284c7',
};

export const PERMISSIONS: Permission[] = [
  { id: 'create_order', label: 'Create Orders', category: 'Orders' },
  { id: 'approve_order', label: 'Approve/Reject Orders', category: 'Orders' },
  { id: 'manage_inventory', label: 'Replenish Stock', category: 'Inventory' },
  { id: 'manage_prices', label: 'Update Prices', category: 'Inventory' },
  { id: 'manage_users', label: 'Manage Employees', category: 'Admin' },
  { id: 'view_reports', label: 'View Reports', category: 'Reports' },
  { id: 'create_custom_reports', label: 'Configure Reports', category: 'Reports' },
];

// Added INITIAL_USERS to fix the import error in App.tsx
export const INITIAL_USERS: User[] = [
  {
    id: 'u1',
    name: 'Roberto Don Rafa',
    email: 'roberto@donrafa.com',
    role: Role.ADMIN,
    brands: ['Finca Don Rafa', 'Yuteco', 'Ecotact'],
    permissions: ['create_order', 'approve_order', 'manage_inventory', 'manage_prices', 'manage_users', 'view_reports', 'create_custom_reports'],
    department: 'Administration'
  },
  {
    id: 'u2',
    name: 'Ana Manager',
    email: 'ana@donrafa.com',
    role: Role.MANAGER,
    brands: ['Finca Don Rafa', 'Yuteco'],
    permissions: ['create_order', 'approve_order', 'manage_inventory', 'view_reports'],
    department: 'Operations'
  },
  {
    id: 'u3',
    name: 'Carlos Employee',
    email: 'carlos@donrafa.com',
    role: Role.EMPLOYEE,
    brands: ['Finca Don Rafa'],
    permissions: ['create_order'],
    department: 'Sales'
  }
];

export const INITIAL_PRODUCTS: Product[] = [
  { 
    id: 'p1', brand: 'Finca Don Rafa', name: 'Arabica Green Coffee', price: 12.5, 
    locationStocks: { 'loc-1': 500, 'loc-2': 200, 'loc-3': 50 },
    lastRestockAmount: 1000, unit: 'kg', category: 'Raw Materials', status: 'ACTIVE',
    history: [
      { id: 'h1', type: 'RESTOCK', eventNumber: 'REST-1000', change: '+1000 units', date: '2023-10-01T10:00:00Z', userId: 'u1', userName: 'Roberto Don Rafa', locationId: 'loc-1' },
      { id: 'h2', type: 'SALE', eventNumber: 'ORD-DEMO', change: '-500 units (ORD-DEMO)', date: '2023-11-05T14:30:00Z', userId: 'u2', userName: 'Ana Manager', locationId: 'loc-1' }
    ]
  },
  { 
    id: 'p2', brand: 'Finca Don Rafa', name: 'Roasted Honey Process', price: 25.0, 
    locationStocks: { 'loc-1': 120, 'loc-2': 80, 'loc-3': 30 },
    lastRestockAmount: 200, unit: 'bag', category: 'Finished Goods', status: 'ACTIVE', history: [] 
  },
  { 
    id: 'p3', brand: 'Yuteco', name: 'Standard Jute Bag 60kg', price: 4.5, 
    locationStocks: { 'loc-1': 2000, 'loc-2': 1500, 'loc-3': 400 },
    lastRestockAmount: 5000, unit: 'pcs', category: 'Packaging', status: 'ACTIVE', history: [] 
  },
  { 
    id: 'p4', brand: 'Yuteco', name: 'Custom Printed Bag', price: 6.2, 
    locationStocks: { 'loc-1': 800, 'loc-2': 300, 'loc-3': 100 },
    lastRestockAmount: 1000, unit: 'pcs', category: 'Packaging', status: 'ACTIVE', history: [] 
  },
  { 
    id: 'p5', brand: 'Ecotact', name: 'Hermetic Liner 70L', price: 8.5, 
    locationStocks: { 'loc-1': 1500, 'loc-2': 1200, 'loc-3': 300 },
    lastRestockAmount: 2000, unit: 'pcs', category: 'Storage', status: 'ACTIVE', history: [] 
  },
  { 
    id: 'p6', brand: 'Ecotact', name: 'Vacuum Pack High-Barrier', price: 15.0, 
    locationStocks: { 'loc-1': 450, 'loc-2': 200, 'loc-3': 50 },
    lastRestockAmount: 500, unit: 'pcs', category: 'Storage', status: 'ACTIVE', history: [] 
  },
];

export const INITIAL_ORDERS: Order[] = [
  {
    id: 'ORD-001',
    brand: 'Finca Don Rafa',
    locationId: 'loc-1',
    creatorId: 'u3',
    creatorName: 'Carlos Employee',
    clientName: 'Starbucks MX',
    clientEmail: 'procurement@starbucks.com.mx',
    status: OrderStatus.PENDING,
    items: [
      { productId: 'p1', productName: 'Arabica Green Coffee', quantity: 100, unitPrice: 12.5 }
    ],
    total: 1250,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString()
  }
];
</file>

<file path="README.md">
<div align="center">
<img width="1200" height="475" alt="GHBanner" src="https://github.com/user-attachments/assets/0aa67016-6eaf-458a-adb2-6e31a0763ed6" />
</div>

# Run and deploy your AI Studio app

This contains everything you need to run your app locally.

View your app in AI Studio: https://ai.studio/apps/drive/1RGEeDlgbZiAmtdWdjksMdPKPeloSoydD

## Run Locally

**Prerequisites:**  Node.js


1. Install dependencies:
   `npm install`
2. Set the `GEMINI_API_KEY` in [.env.local](.env.local) to your Gemini API key
3. Run the app:
   `npm run dev`
</file>

<file path="types.ts">
export enum Role {
  ADMIN = 'ADMIN',
  MANAGER = 'MANAGER',
  EMPLOYEE = 'EMPLOYEE'
}

export type Brand = 'Finca Don Rafa' | 'Yuteco' | 'Ecotact';

export enum OrderStatus {
  PENDING = 'PENDING',
  CONFIRMED = 'CONFIRMED',
  PAID = 'PAID',
  PRODUCTION = 'IN PRODUCTION',
  SHIPPED = 'SHIPPED/DELIVERED',
  REJECTED = 'REJECTED'
}

export interface Location {
  id: string;
  name: string;
  address: string;
}

export interface LogEntry {
  id: string;
  type: 'RESTOCK' | 'SALE' | 'PRICE_CHANGE' | 'CATALOG_CREATE' | 'CATALOG_UPDATE';
  eventNumber: string; 
  change: string;      
  date: string;
  quantity?: string;   
  authorizerName?: string; 
  userId: string;
  userName: string;
  locationId?: string; // Track where the event happened
}

export interface User {
  id: string;
  name: string;
  email: string;
  role: Role;
  brands: Brand[];
  permissions: string[];
  department: string;
}

export interface Product {
  id: string;
  brand: Brand;
  name: string;
  price: number;
  // Stock is now a map of locationId -> quantity
  locationStocks: Record<string, number>; 
  lastRestockAmount: number;
  unit: string;
  category: string;
  history: LogEntry[];
  status: 'ACTIVE' | 'INACTIVE' | 'DELETED';
  observations?: string;
}

export interface OrderItem {
  productId: string;
  productName: string;
  quantity: number;
  unitPrice: number;
}

export interface Order {
  id: string;
  brand: Brand;
  locationId: string; // Fulfillment location
  creatorId: string;
  creatorName: string;
  clientName: string;
  clientEmail: string;
  status: OrderStatus;
  items: OrderItem[];
  total: number;
  createdAt: string;
  updatedAt: string;
  managerNote?: string;
}

export interface Permission {
  id: string;
  label: string;
  category: 'Orders' | 'Inventory' | 'Admin' | 'Reports';
}
</file>

</files>
